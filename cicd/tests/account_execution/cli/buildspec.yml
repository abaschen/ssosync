version: 0.2

env:
  secrets-manager:
    SCIMAccessToken: ssosync-staging/aws/SCIMAccessToken
    SSOSyncGoogleCredentials: ssosync-staging/google/ServiceAccountCredentials
  parameter-store:
    SCIMEndpointUrl: /SSOSync-Staging/aws/SCIMEndpointUrl
    IdentityStoreID: /SSOSync-Staging/aws/IdentityStoreId
    GoogleAdminEmail: /SSOSync-Staging/google/SSOSyncGoogleAdminEmail
    Region: /SSOSync-Staging/aws/Region

  variables:
    ExpectedExitState: 0

phases:
  pre_build:
    commands:
      # Print all environment variables (handy for AWS CodeBuild logs)
      - env

  build:
    commands:
      - ./ssosync --version
      - cat $SSOSyncGoogleCredentials > credentials.json
      - cat credentials.json

      - ./ssosync -t "${SCIMAccessToken}" -e "${SCIMEndpointUrl}" -u "${GoogleAdminEmail}" -i "${IdentityStoreID}" -r "${Region}" -s "groups" -g "name:AWS*"; ExitState=$?

      - |
        if expr "${ExitState}" : "${ExpectedExitState}" >/dev/null; then
          echo "We got what we expected"
          exit 0
        else
          echo "We didn't get what we expected"
          exit 1
        fi
